[
    {
        "id": "3bcad979e3234c31",
        "type": "tab",
        "label": "node v√†o/ra",
        "disabled": false,
        "info": ""
    },
    {
        "id": "1b48354d57473ee9",
        "type": "tab",
        "label": "node ·ªü ch·ªó ƒë·ªó xe ",
        "disabled": false,
        "info": ""
    },
    {
        "id": "a16b73657f0d2c2a",
        "type": "tab",
        "label": "dashboard b√£i ƒë·ªó xe",
        "disabled": false,
        "info": ""
    },
    {
        "id": "aee7f3977f504759",
        "type": "firebase config",
        "firebaseurl": "smartparking-7d8b2-default-rtdb",
        "loginType": "none"
    },
    {
        "id": "ui_tab_parking",
        "type": "ui_tab",
        "name": "Gi√°m s√°t b√£i xe",
        "icon": "dashboard",
        "order": 1,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "ui_group_lot1",
        "type": "ui_group",
        "name": "Lot 1: 144 Xu√¢n Thu·ª∑ - C·∫ßu Gi·∫•y - H√† N·ªôi",
        "tab": "ui_tab_parking",
        "order": 1,
        "disp": true,
        "width": "12",
        "collapse": false,
        "className": ""
    },
    {
        "id": "d4352cd696f371f7",
        "type": "ui_base",
        "theme": {
            "name": "theme-light",
            "lightTheme": {
                "default": "#0094CE",
                "baseColor": "#0094CE",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": false
            },
            "darkTheme": {
                "default": "#097479",
                "baseColor": "#097479",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
                "edited": false
            },
            "customTheme": {
                "name": "Untitled Theme 1",
                "default": "#4B7930",
                "baseColor": "#4B7930",
                "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
            },
            "themeState": {
                "base-color": {
                    "default": "#0094CE",
                    "value": "#0094CE",
                    "edited": false
                },
                "page-titlebar-backgroundColor": {
                    "value": "#0094CE",
                    "edited": false
                },
                "page-backgroundColor": {
                    "value": "#fafafa",
                    "edited": false
                },
                "page-sidebar-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-textColor": {
                    "value": "#1bbfff",
                    "edited": false
                },
                "group-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "group-backgroundColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "widget-textColor": {
                    "value": "#111111",
                    "edited": false
                },
                "widget-backgroundColor": {
                    "value": "#0094ce",
                    "edited": false
                },
                "widget-borderColor": {
                    "value": "#ffffff",
                    "edited": false
                },
                "base-font": {
                    "value": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
                }
            },
            "angularTheme": {
                "primary": "indigo",
                "accents": "blue",
                "warn": "red",
                "background": "grey",
                "palette": "light"
            }
        },
        "site": {
            "name": "Node-RED Dashboard",
            "hideToolbar": "false",
            "allowSwipe": "false",
            "lockMenu": "false",
            "allowTempTheme": "true",
            "dateFormat": "DD/MM/YYYY",
            "sizes": {
                "sx": 48,
                "sy": 48,
                "gx": 6,
                "gy": 6,
                "cx": 6,
                "cy": 6,
                "px": 0,
                "py": 0
            }
        }
    },
    {
        "id": "bfc4b6c8944ad373",
        "type": "http in",
        "z": "3bcad979e3234c31",
        "name": "",
        "url": "esp8266/rfid_in",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 100,
        "y": 140,
        "wires": [
            [
                "45ed03fceed39806",
                "08591338e8fb8793"
            ]
        ]
    },
    {
        "id": "45ed03fceed39806",
        "type": "json",
        "z": "3bcad979e3234c31",
        "name": "",
        "property": "payload",
        "action": "obj",
        "pretty": false,
        "x": 230,
        "y": 240,
        "wires": [
            [
                "6bb441ef728eee9e"
            ]
        ]
    },
    {
        "id": "6bb441ef728eee9e",
        "type": "function",
        "z": "3bcad979e3234c31",
        "name": "C·∫≠p nh·∫≠t RFID v√† l∆∞u th√¥ng tin",
        "func": "// üé´ 1. L·∫•y RFID t·ª´ payload g·ªëc\nconst rfid_uid = msg.payload.rfid_uid;\nif (!rfid_uid) {\n    node.error(\"Thi·∫øu rfid_uid trong payload XE V√ÄO\", msg);\n    msg.payload = { \n        action: \"error\",\n        message: \"Y√™u c·∫ßu kh√¥ng h·ª£p l·ªá: Thi·∫øu rfid_uid.\",\n        available_spots: null\n    };\n    msg.statusCode = 400;\n    return null;      // d·ª´ng flow, s·∫Ω c√≥ HTTP-response ri√™ng\n}\n\n// Chu·∫©n ho√° RFID th√†nh CH·ªÆ HOA ƒë·ªÉ so kh·ªõp DB\nmsg.rfid_uid_received = rfid_uid.toUpperCase();\nmsg.original_http_payload = msg.payload;   // l∆∞u ƒë·ªÉ d√πng ti·∫øp\n\n/*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n  2. Chu·∫©n b·ªã QUERY cho node firebase.once\n    ‚Ä¢ orderByChild  : s·∫Øp theo tr∆∞·ªùng rfid_tag_expected\n    ‚Ä¢ equalTo       : b·∫±ng ƒë√∫ng RFID v·ª´a qu√©t\n    ‚Ä¢ limitToFirst  : ch·ªâ l·∫•y 1 record (gi·∫£m bƒÉng th√¥ng)\n   ‚Äª Firebase RTDB ch·ªâ cho 1 orderBy‚Ä¶/equalTo m·ªói truy v·∫•n,\n     n√™n ta l·ªçc RFID tr√™n server, c√≤n status (active/confirmed)\n     s·∫Ω l·ªçc ti·∫øp trong Function sau khi nh·∫≠n v·ªÅ.\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/\n\nmsg.payload = {\n  orderByChild : \"rfid_tag_expected\",\n  equalTo      : msg.rfid_uid_received,\n  limitToFirst : 1          // tu·ª≥ ch·ªçn nh∆∞ng n√™n c√≥\n};\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 120,
        "wires": [
            [
                "3acfbee4dc6e7c08",
                "e0e91be86a8662f0"
            ]
        ]
    },
    {
        "id": "861d27250d9190e7",
        "type": "function",
        "z": "3bcad979e3234c31",
        "name": "Ki·ªÉm tra bookings tr√™n server",
        "func": "// K·∫øt qu·∫£ t·ª´ Firebase Get (to√†n b·ªô nh√°nh bookings)\nmsg.bookings_query_result = msg.payload;\n\nmsg.has_valid_reservation = false;\nmsg.reserved_spot_id = null;\nmsg.booking_id_to_update = null;\n\nconst rfid_uid_received = msg.rfid_uid_received; // L·∫•y RFID ƒë√£ nh·∫≠n t·ª´ node tr∆∞·ªõc\n\nif (msg.bookings_query_result && typeof msg.bookings_query_result === 'object') {\n    const bookingIds = Object.keys(msg.bookings_query_result);\n    for (const bookingId of bookingIds) {\n        const booking = msg.bookings_query_result[bookingId];\n\n        // Th√™m ƒëi·ªÅu ki·ªán ki·ªÉm tra rfid_tag_expected V√Ä c√°c ƒëi·ªÅu ki·ªán kh√°c\n        if ((booking.status === 'active' || booking.status === 'confirmed') &&\n            booking.spot_ID &&\n            booking.lot_ID === 'lot_1' &&\n            booking.rfid_tag_expected === rfid_uid_received // TH√äM D√íNG N√ÄY ƒê·ªÇ L·ªåC TR√äN NODE-RED\n        ) {\n             msg.has_valid_reservation = true;\n             msg.reserved_spot_id = booking.spot_ID;\n             msg.booking_id_to_update = bookingId;\n             break; // T√¨m th·∫•y 1 booking h·ª£p l·ªá, d·ª´ng l·∫°i\n        }\n    }\n}\n\ndelete msg.payload;\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 100,
        "wires": [
            [
                "c925da490a3e1b6c",
                "34e50b7479ad36ec"
            ]
        ]
    },
    {
        "id": "c925da490a3e1b6c",
        "type": "switch",
        "z": "3bcad979e3234c31",
        "name": "ƒê√£ booking ch·ªó ch∆∞a",
        "property": "has_valid_reservation",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1040,
        "y": 180,
        "wires": [
            [
                "b863f79f19227765"
            ],
            [
                "6c55461978ec3081"
            ]
        ]
    },
    {
        "id": "908f454b96d4dd07",
        "type": "function",
        "z": "3bcad979e3234c31",
        "name": "ƒê√£ ƒë·∫∑t ch·ªó: chu·∫©n b·ªã c·∫≠p nh·∫≠t th√¥ng tin ",
        "func": "msg.action_result_final = \"open_reserved\";\nmsg.message_final = `M·ªùi v√†o ch·ªó ƒë·∫∑t tr∆∞·ªõc: ${msg.reserved_spot_id}.`;\nmsg.statusCode_final = 200;\n\n// Chu·∫©n b·ªã c·∫≠p nh·∫≠t Firebase: c·∫≠p nh·∫≠t spot status th√†nh pending_entries\n// v√† gi·∫£m available_spots ƒëi 1 ngay l·∫≠p t·ª©c.\n\nlet updatePayload = {};\nupdatePayload[`parking_lots/lot_1/spots/${msg.reserved_spot_id}/status`] = \"pending_entries\";\nupdatePayload[`parking_lots/lot_1/spots/${msg.reserved_spot_id}/rfid_tag`] = msg.rfid_uid_received;\nupdatePayload[`parking_lots/lot_1/spots/${msg.reserved_spot_id}/time_in`] = new Date().toISOString();\n\n// ƒê·ªçc s·ªë ch·ªó tr·ªëng hi·ªán t·∫°i v√† t·ªïng s·ªë ch·ªó t·ª´ d·ªØ li·ªáu b√£i ƒë·ªó (msg.payload t·ª´ 78de2ad6bce037b7)\n// Gi·∫£ ƒë·ªãnh msg.payload (sau node 78de2ad6bce037b7) l√† to√†n b·ªô data parking_lots/lot_1\nconst lotData = msg.payload; \nconst totalSpots = parseInt(lotData.total_spots) || 0;\n\nlet occupiedCount = 0;\nlet reservedCount = 0;\nlet pendingCount = 0;\n\n// ƒê·∫øm c√°c tr·∫°ng th√°i hi·ªán t·∫°i t·ª´ lotData\nfor (const spotId of Object.keys(lotData.spots || {})) {\n    const spot = lotData.spots[spotId];\n    if (spot.status === \"occupied\") {\n        occupiedCount++;\n    } else if (spot.status === \"reserved\") {\n        reservedCount++;\n    } else if (spot.status === \"pending_entries\") {\n        pendingCount++;\n    }\n}\n\n// C·∫≠p nh·∫≠t s·ªë pending_entries sau khi xe v√†o (tƒÉng 1)\npendingCount++;\n\n// T√≠nh to√°n l·∫°i available_spots\nconst newAvailableSpots = Math.max(0, totalSpots - reservedCount - occupiedCount - pendingCount);\nupdatePayload[`parking_lots/lot_1/available_spots`] = newAvailableSpots; // C·∫≠p nh·∫≠t available_spots\nmsg.spots_to_report_in_response = newAvailableSpots;\n\nmsg.payload = updatePayload;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1480,
        "y": 60,
        "wires": [
            [
                "d5a6313c0e481b5a",
                "0fdd3b76ba0c12bd"
            ]
        ]
    },
    {
        "id": "35f435f3318317dc",
        "type": "function",
        "z": "3bcad979e3234c31",
        "name": "Ch∆∞a ƒë·∫∑t ch·ªó: ki·ªÉm tra v√† c·∫≠p nh·∫≠t l√™n h·ªá th·ªëng",
        "func": "const rfid = msg.rfid_uid_received;\nconst lotData = msg.payload; // lotData l√† d·ªØ li·ªáu t·ª´ parking_lots/lot_1\n\nlet foundSpotId = null;\nlet updatePayload = {};\n\n// Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o\nif (!lotData || typeof lotData !== 'object' || !lotData.spots) {\n    node.error(\"ENTRY WALKIN: Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu spots h·ª£p l·ªá t·ª´ Firebase.\", msg);\n    msg.perform_walkin_update = false;\n    msg.statusCode_final = 500;\n    msg.action_result_final = \"error_walkin\";\n    msg.message_final = \"L·ªói h·ªá th·ªëng (walk-in entry): D·ªØ li·ªáu b√£i ƒë·ªó kh√¥ng ƒë√∫ng.\";\n    msg.spots_to_report_in_response = lotData && typeof lotData.available_spots !== 'undefined' ? parseInt(lotData.available_spots) : null;\n    return msg;\n}\n\n// Duy·ªát t√¨m 1 ch·ªó tr·ªëng c√≥ status l√† \"empty\"\nconst spotIds = Object.keys(lotData.spots);\nfor (const spotId of spotIds) {\n    const spot = lotData.spots[spotId];\n    if (spot.status === \"empty\") {\n        foundSpotId = spotId;\n        break;\n    }\n}\n\nlet newAvailableSpots = 0; // Kh·ªüi t·∫°o gi√° tr·ªã ch·ªó tr·ªëng m·ªõi\n\nif (foundSpotId) {\n    // N·∫øu t√¨m th·∫•y ch·ªó tr·ªëng: Chu·∫©n b·ªã c·∫≠p nh·∫≠t cho spot c·ª• th·ªÉ th√†nh 'pending_entries'\n    updatePayload[`parking_lots/lot_1/spots/${foundSpotId}/status`] = \"pending_entries\";\n    updatePayload[`parking_lots/lot_1/spots/${foundSpotId}/rfid_tag`] = rfid;\n    updatePayload[`parking_lots/lot_1/spots/${foundSpotId}/time_in`] = new Date().toISOString();\n\n    // T√≠nh to√°n l·∫°i available_spots ngay l·∫≠p t·ª©c\n    const totalSpots = parseInt(lotData.total_spots) || 0;\n    let occupiedCount = 0;\n    let reservedCount = 0;\n    let pendingCount = 0;\n\n    // ƒê·∫øm c√°c tr·∫°ng th√°i hi·ªán t·∫°i t·ª´ lotData\n    for (const spotId of spotIds) {\n        const spot = lotData.spots[spotId];\n        if (spot.status === \"occupied\") {\n            occupiedCount++;\n        } else if (spot.status === \"reserved\") {\n            reservedCount++;\n        } else if (spot.status === \"pending_entries\") {\n            pendingCount++;\n        }\n    }\n    \n    // C·∫≠p nh·∫≠t s·ªë pending_entries sau khi xe v√†o (tƒÉng 1)\n    pendingCount++;\n\n    newAvailableSpots = Math.max(0, totalSpots - reservedCount - occupiedCount - pendingCount);\n    updatePayload[`parking_lots/lot_1/available_spots`] = newAvailableSpots;\n\n    msg.perform_walkin_update = true;\n    msg.payload = updatePayload; // Payload n√†y s·∫Ω ƒë∆∞·ª£c g·ª≠i t·ªõi node firebase modify\n\n    // Thi·∫øt l·∫≠p c√°c c·ªù cho ph·∫£n h·ªìi HTTP cu·ªëi c√πng\n    msg.statusCode_final = 200;\n    msg.action_result_final = \"open_walk_in\";\n    msg.message_final = `M·ªùi xe v√£ng lai v√†o ch·ªó ${foundSpotId}.`;\n    msg.spots_to_report_in_response = newAvailableSpots; // B√°o c√°o gi√° tr·ªã m·ªõi t√≠nh ƒë∆∞·ª£c\n\n} else {\n    // N·∫øu kh√¥ng t√¨m th·∫•y ch·ªó tr·ªëng n√†o\n    msg.perform_walkin_update = false;\n    msg.statusCode_final = 403; // Forbidden\n    msg.action_result_final = \"deny_walk_in\";\n    msg.message_final = \"B√£i ƒë√£ h·∫øt ch·ªó cho xe v√£ng lai.\";\n    // B√°o c√°o s·ªë ch·ªó tr·ªëng hi·ªán t·∫°i (l·∫•y t·ª´ d·ªØ li·ªáu database ƒë·ªçc ƒë∆∞·ª£c)\n    let currentOccupied = 0;\n    let currentReserved = 0;\n    let currentPending = 0;\n    for (const spotId of spotIds) {\n        const spot = lotData.spots[spotId];\n        if (spot.status === \"occupied\") {\n            currentOccupied++;\n        } else if (spot.status === \"reserved\") {\n            currentReserved++;\n        } else if (spot.status === \"pending_entries\") {\n            currentPending++;\n        }\n    }\n    msg.spots_to_report_in_response = Math.max(0, totalSpots - currentOccupied - currentReserved - currentPending); // B√°o c√°o s·ªë ch·ªó tr·ªëng hi·ªán t·∫°i\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1630,
        "y": 300,
        "wires": [
            [
                "5d32da0199d28830",
                "31ac22796785a1fe"
            ]
        ]
    },
    {
        "id": "5d32da0199d28830",
        "type": "switch",
        "z": "3bcad979e3234c31",
        "name": "C√≤n ch·ªó h√£y kh√¥ng",
        "property": "perform_walkin_update",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1950,
        "y": 260,
        "wires": [
            [
                "2a2154627b9cc6f8"
            ],
            [
                "7d8b4c92a45976d3"
            ]
        ]
    },
    {
        "id": "f2233f9863e6e7aa",
        "type": "function",
        "z": "3bcad979e3234c31",
        "name": "Th√¥ng b√°o ƒë√£ v√†o th√†nh c√¥ng",
        "func": "msg.payload = {\n    action: msg.action_result_final,\n    message: msg.message_final,\n    rfid_received: msg.rfid_uid_received,\n    available_spots: msg.spots_to_report_in_response \n};\nmsg.statusCode = msg.statusCode_final;\n\n// D·ªçn d·∫πp (gi·ªØ l·∫°i c√°c tr∆∞·ªùng c·∫ßn thi·∫øt cho ph·∫£n h·ªìi)\nconst responsePayload = msg.payload;\nconst statusCode = msg.statusCode;\n\n// X√≥a t·∫•t c·∫£ c√°c tr∆∞·ªùng kh√°c trong msg tr·ª´ _msgid\nfor (const key in msg) {\n    if (key !== '_msgid' && key !== 'payload' && key !== 'statusCode') {\n        delete msg[key];\n    }\n}\n\nmsg.payload = responsePayload; // G√°n l·∫°i payload ph·∫£n h·ªìi\nmsg.statusCode = statusCode; // G√°n l·∫°i statusCode ph·∫£n h·ªìi\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2420,
        "y": 100,
        "wires": [
            [
                "20bb7537c93657b3",
                "bc9bb00bb73abea2"
            ]
        ]
    },
    {
        "id": "bc9bb00bb73abea2",
        "type": "http response",
        "z": "3bcad979e3234c31",
        "name": "M·ªü c·ªïng",
        "statusCode": "",
        "headers": {},
        "x": 2700,
        "y": 100,
        "wires": []
    },
    {
        "id": "aefbf2e41380e311",
        "type": "http in",
        "z": "3bcad979e3234c31",
        "name": "",
        "url": "/esp8266_out",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 90,
        "y": 780,
        "wires": [
            [
                "534ba754c789ac8c"
            ]
        ]
    },
    {
        "id": "534ba754c789ac8c",
        "type": "json",
        "z": "3bcad979e3234c31",
        "name": "",
        "property": "payload",
        "action": "obj",
        "pretty": false,
        "x": 230,
        "y": 860,
        "wires": [
            [
                "d89bd759321da301"
            ]
        ]
    },
    {
        "id": "d89bd759321da301",
        "type": "function",
        "z": "3bcad979e3234c31",
        "name": "C·∫≠p nh·∫≠t RFID v√† l∆∞u th√¥ng tin",
        "func": "const rfid_uid = msg.payload.rfid_uid;\nif (!rfid_uid) {\n    node.error(\"Thi·∫øu rfid_uid trong payload XE RA\", msg);\n    msg.payload = { action: \"error\", message: \"Y√™u c·∫ßu kh√¥ng h·ª£p l·ªá XE RA: Thi·∫øu rfid_uid.\", available_spots: null };\n    msg.statusCode = 400;\n    return msg; \n}\nmsg.rfid_uid_received = rfid_uid.toUpperCase();\n\n// Chu·∫©n b·ªã l·∫•y d·ªØ li·ªáu to√†n b·ªô DB ƒë·ªÉ t√¨m spot c√≥ rfid_tag kh·ªõp\n// Childpath ƒë·ªÉ tr·ªëng ƒë·ªÉ l·∫•y to√†n b·ªô DB, sau ƒë√≥ l·ªçc trong Function\nmsg.firebase_get_path = \"\"; // ƒê√£ set childpath cho node firebase.once ti·∫øp theo\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 780,
        "wires": [
            [
                "e55caf42c0936b6d",
                "df115a108ed489e0"
            ]
        ]
    },
    {
        "id": "ded77b69850a81fe",
        "type": "function",
        "z": "3bcad979e3234c31",
        "name": "Ki·ªÉm tra th·∫ª RFID",
        "func": "// msg.payload hi·ªán t·∫°i ch·ª©a TO√ÄN B·ªò c·∫•u tr√∫c database Firebase (parking_lots v√† bookings)\n// msg.rfid_uid_received ch·ª©a RFID ƒë√£ qu√©t (·ªü d·∫°ng ch·ªØ HOA)\n\nconst fullDbData = msg.payload;\nconst rfidToFind = msg.rfid_uid_received;\nconst currentTime = new Date().toISOString(); // L·∫•y th·ªùi gian hi·ªán t·∫°i theo ƒë·ªãnh d·∫°ng ISO 8601\n\nlet spotToUpdateId = null;\nlet bookingToDeleteRef = null; // L∆∞u tr·ªØ tham chi·∫øu booking n·∫øu t√¨m th·∫•y\nlet updatedPayload = JSON.parse(JSON.stringify(fullDbData)); // Deep copy ƒë·ªÉ s·ª≠a ƒë·ªïi\n\n\n// --- 1. Ki·ªÉm tra c·∫•u tr√∫c d·ªØ li·ªáu database nh·∫≠n ƒë∆∞·ª£c ---\nif (typeof updatedPayload !== 'object' || updatedPayload === null ||\n    !updatedPayload.parking_lots || !updatedPayload.parking_lots.lot_1 || !updatedPayload.parking_lots.lot_1.spots) {\n\n    node.error(`EXIT (Full DB Read): C·∫•u tr√∫c database kh√¥ng h·ª£p l·ªá ho·∫∑c thi·∫øu node quan tr·ªçng.`, msg);\n\n    msg.action_result_final = \"error_exit\";\n    msg.message_final = \"L·ªói h·ªá th·ªëng (exit): D·ªØ li·ªáu b√£i ƒë·ªó kh√¥ng ƒë√∫ng ho·∫∑c thi·∫øu.\";\n    msg.spots_to_report_in_response = null; // Kh√¥ng b√°o c√°o s·ªë ch·ªó tr·ªëng ·ªü ƒë√¢y n·ªØa\n    msg.statusCode_final = 500;\n\n    // X√≥a payload ƒë·ªÉ tr√°nh g·ª≠i d·ªØ li·ªáu l·ªói cho node firebase modify\n    msg.payload = {};\n\n    // Tr·∫£ v·ªÅ message l·ªói qua output 2\n    return [null, msg];\n}\n\nconst lotData = updatedPayload.parking_lots.lot_1;\nconst spots = lotData.spots;\nconst totalSpots = parseInt(lotData.total_spots) || 0;\n\n\n// --- 2. T√¨m ch·ªó ƒë·ªó ƒëang c√≥ xe v·ªõi RFID kh·ªõp (bao g·ªìm c·∫£ tr∆∞·ªùng h·ª£p IR ƒë√£ b√°o empty) ---\nconst spotIds = Object.keys(spots || {});\nfor (const spotId of spotIds) {\n    const spot = spots[spotId];\n    // T√¨m spot c√≥ rfid_tag kh·ªõp V√Ä (ƒëang ·ªü tr·∫°ng th√°i 'occupied' HO·∫∂C 'pending_entries' HO·∫∂C 'empty' nh∆∞ng v·∫´n c√≥ rfid_tag)\n    // IR kh√¥ng x√≥a rfid_tag n√™n ch√∫ng ta c√≥ th·ªÉ t√¨m th·∫•y n√≥ ngay c·∫£ khi spot ƒë√£ l√† empty.\n    if (spot && spot.rfid_tag === rfidToFind && (spot.status === \"occupied\" || spot.status === \"pending_entries\" || spot.status === \"empty\" || spot.status === \"reserved\")) {\n        // Lu√¥n ∆∞u ti√™n x·ª≠ l√Ω xe ra n·∫øu RFID kh·ªõp\n        spotToUpdateId = spotId;\n        if (spot.booking_ref) {\n            bookingToDeleteRef = spot.booking_ref;\n        }\n        break;\n    }\n}\n\n// --- 3. Chu·∫©n b·ªã payload c·∫≠p nh·∫≠t/x√≥a v√† ph·∫£n h·ªìi d·ª±a tr√™n k·∫øt qu·∫£ t√¨m ki·∫øm ---\nif (spotToUpdateId) {\n    // L·∫•y tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa ch·ªó ƒë·ªó tr∆∞·ªõc khi c·∫≠p nh·∫≠t\n    const currentSpotStatus = spots[spotToUpdateId].status;\n\n    // --- C·∫≠p nh·∫≠t tr·∫°ng th√°i ch·ªó ƒë·ªó trong payload ---\n    spots[spotToUpdateId].status = \"empty\"; // Chuy·ªÉn ch·ªó ƒë·ªó th√†nh empty\n    spots[spotToUpdateId].rfid_tag = null; // X√≥a RFID khi xe ra kh·ªèi c·ªïng\n    spots[spotToUpdateId].time_in = null; // X√≥a time_in\n    spots[spotToUpdateId].time_out = currentTime; // L∆∞u time_out\n    spots[spotToUpdateId].booking_ref = null; // X√≥a tham chi·∫øu booking tr√™n spot\n    spots[spotToUpdateId].phone_number = null; // X√≥a phone_number tr√™n spot\n    spots[spotToUpdateId].userID = null; // X√≥a userID tr√™n spot\n    spots[spotToUpdateId].booking_start_time = null; // X√≥a th·ªùi gian booking d·ª± ki·∫øn\n    spots[spotToUpdateId].booking_end_time = null; // X√≥a th·ªùi gian booking d·ª± ki·∫øn\n\n\n    // T√≠nh to√°n l·∫°i available_spots ch·ªâ khi tr·∫°ng th√°i ƒêANG TH·ª∞C S·ª∞ THAY ƒê·ªîI T·ª™ C√ì XE SANG KH√îNG C√ì XE\n    // T·ª©c l√†, n·∫øu tr∆∞·ªõc ƒë√≥ l√† 'occupied', 'pending_entries', 'reserved' (v√† rfid kh·ªõp)\n    // N·∫øu n√≥ ƒë√£ l√† 'empty' r·ªìi th√¨ kh√¥ng c·∫ßn tƒÉng available_spots n·ªØa (v√¨ IR ƒë√£ l√†m)\n    let shouldIncreaseAvailableSpots = false;\n    if (currentSpotStatus === \"occupied\" || currentSpotStatus === \"pending_entries\" || currentSpotStatus === \"reserved\") {\n        shouldIncreaseAvailableSpots = true;\n    }\n\n    let occupiedCount = 0;\n    let reservedCount = 0;\n    let pendingCount = 0;\n\n    // ƒê·∫øm c√°c tr·∫°ng th√°i HI·ªÜN T·∫†I t·ª´ updatedPayload (bao g·ªìm ch·ªó v·ª´a chuy·ªÉn sang empty)\n    for (const spotId of Object.keys(spots || {})) {\n        const spot = spots[spotId];\n        if (spot.status === \"occupied\") {\n            occupiedCount++;\n        } else if (spot.status === \"reserved\") {\n            reservedCount++;\n        } else if (spot.status === \"pending_entries\") {\n            pendingCount++;\n        }\n    }\n\n    // T√≠nh to√°n l·∫°i available_spots\n    const newAvailableSpots = Math.max(0, totalSpots - reservedCount - occupiedCount - pendingCount);\n    lotData.available_spots = newAvailableSpots; // C·∫≠p nh·∫≠t available_spots\n\n\n    // --- X·ª≠ l√Ω x√≥a Booking trong payload (n·∫øu t√¨m th·∫•y booking_ref) ---\n    if (bookingToDeleteRef && updatedPayload.bookings && updatedPayload.bookings[bookingToDeleteRef]) {\n        updatedPayload.bookings[bookingToDeleteRef] = null; // ƒê·∫∑t th√†nh null ƒë·ªÉ Firebase x√≥a\n        node.warn(`[EXIT] ƒê√£ t√¨m th·∫•y booking ${bookingToDeleteRef} cho xe ra t·∫°i ch·ªó ${spotToUpdateId}. Chu·∫©n b·ªã xo√° booking.`);\n    } else if (bookingToDeleteRef) {\n         node.warn(`[EXIT] C·∫£nh b√°o: Booking ref ${bookingToDeleteRef} t√¨m th·∫•y tr√™n ch·ªó ${spotToUpdateId} nh∆∞ng kh√¥ng t·ªìn t·∫°i trong node /bookings.`);\n    }\n\n    // --- Chu·∫©n b·ªã message ph·∫£n h·ªìi th√†nh c√¥ng ---\n    msg.action_result_final = \"exit_success\";\n    msg.message_final = \"C·∫£m ∆°n ƒë√£ s·ª≠ d·ª•ng d·ªãch v·ª•!\";\n    msg.spots_to_report_in_response = newAvailableSpots; // B√°o c√°o s·ªë ch·ªó tr·ªëng m·ªõi\n    msg.statusCode_final = 200;\n\n    msg.payload = updatedPayload; // Payload n√†y s·∫Ω ƒë∆∞·ª£c g·ª≠i t·ªõi node firebase modify\n    return [msg, null]; // G·ª≠i v·ªÅ nh√°nh th√†nh c√¥ng\n\n} else {\n    // --- X·ª≠ l√Ω kh√¥ng t√¨m th·∫•y xe ƒëang ƒë·ªó v·ªõi RFID n√†y ---\n    msg.action_result_final = \"exit_rfid_not_found\";\n    msg.message_final = \"Kh√¥ng t√¨m th·∫•y xe v·ªõi RFID n√†y ƒëang ƒë·ªó trong b√£i ho·∫∑c xe ch∆∞a v√†o ƒë√∫ng quy tr√¨nh.\";\n    // B√°o c√°o s·ªë ch·ªó tr·ªëng hi·ªán t·∫°i (l·∫•y t·ª´ d·ªØ li·ªáu database ƒë·ªçc ƒë∆∞·ª£c)\n    let currentOccupied = 0;\n    let currentReserved = 0;\n    let currentPending = 0;\n    for (const spotId of spotIds) {\n        const spot = spots[spotId];\n        if (spot.status === \"occupied\") {\n            currentOccupied++;\n        } else if (spot.status === \"reserved\") {\n            currentReserved++;\n        } else if (spot.status === \"pending_entries\") {\n            currentPending++;\n        }\n    }\n    msg.spots_to_report_in_response = Math.max(0, totalSpots - currentOccupied - currentReserved - currentPending);\n    msg.statusCode_final = 404; // Not Found\n\n    msg.payload = {};\n    return [null, msg]; // G·ª≠i v·ªÅ nh√°nh l·ªói\n}",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 780,
        "wires": [
            [
                "510a0e109fb915fc",
                "9cf35b477c8ca2e7"
            ],
            [
                "94f36abdded89077",
                "7854a6bbf8335901"
            ]
        ]
    },
    {
        "id": "30480459d62a1732",
        "type": "function",
        "z": "3bcad979e3234c31",
        "name": "Th√¥ng b√°o xe ra th√†nh c√¥ng",
        "func": "msg.payload = {\n    action: msg.action_result_final,\n    message: msg.message_final,\n    rfid_received: msg.rfid_uid_received,\n    available_spots: msg.spots_to_report_in_response\n};\nmsg.statusCode = msg.statusCode_final;\n\n// D·ªçn d·∫πp (gi·ªØ l·∫°i c√°c tr∆∞·ªùng c·∫ßn thi·∫øt cho ph·∫£n h·ªìi)\nconst responsePayload = msg.payload;\nconst statusCode = msg.statusCode;\n\n// X√≥a t·∫•t c·∫£ c√°c tr∆∞·ªùng kh√°c trong msg tr·ª´ _msgid\nfor (const key in msg) {\n    if (key !== '_msgid' && key !== 'payload' && key !== 'statusCode') {\n        delete msg[key];\n    }\n}\n\nmsg.payload = responsePayload; // G√°n l·∫°i payload ph·∫£n h·ªìi\nmsg.statusCode = statusCode; // G√°n l·∫°i statusCode ph·∫£n h·ªìi\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1320,
        "y": 680,
        "wires": [
            [
                "e3aeba92dfe2c66f",
                "01370e80ad490e9b"
            ]
        ]
    },
    {
        "id": "e3aeba92dfe2c66f",
        "type": "http response",
        "z": "3bcad979e3234c31",
        "name": "M·ªü c·ªïng",
        "statusCode": "",
        "headers": {},
        "x": 1600,
        "y": 680,
        "wires": []
    },
    {
        "id": "3acfbee4dc6e7c08",
        "type": "firebase.once",
        "z": "3bcad979e3234c31",
        "name": "ƒê·ªçc bookings tr√™n server",
        "firebaseconfig": "aee7f3977f504759",
        "childpath": "bookings",
        "repeatifnull": false,
        "eventType": "value",
        "queries": [],
        "x": 590,
        "y": 220,
        "wires": [
            [
                "861d27250d9190e7"
            ]
        ]
    },
    {
        "id": "6c55461978ec3081",
        "type": "firebase.once",
        "z": "3bcad979e3234c31",
        "name": "Ki·ªÉm tra server c√≤n ch·ªó kh√¥ng",
        "firebaseconfig": "aee7f3977f504759",
        "childpath": "parking_lots/lot_1",
        "repeatifnull": false,
        "eventType": "value",
        "queries": [],
        "x": 1330,
        "y": 200,
        "wires": [
            [
                "35f435f3318317dc"
            ]
        ]
    },
    {
        "id": "d5a6313c0e481b5a",
        "type": "firebase modify",
        "z": "3bcad979e3234c31",
        "name": "C·∫≠p nh·∫≠t th√¥ng tin l√™n server",
        "firebaseconfig": "aee7f3977f504759",
        "childpath": "",
        "method": "update",
        "value": "msg.payload",
        "priority": "msg.priority",
        "x": 1840,
        "y": 60,
        "wires": [
            [
                "f2233f9863e6e7aa"
            ]
        ]
    },
    {
        "id": "2a2154627b9cc6f8",
        "type": "firebase modify",
        "z": "3bcad979e3234c31",
        "name": "C·∫≠p nh·∫≠t th√¥ng tin l√™n server",
        "firebaseconfig": "aee7f3977f504759",
        "childpath": "",
        "method": "update",
        "value": "msg.payload",
        "priority": "msg.priority",
        "x": 2140,
        "y": 180,
        "wires": [
            [
                "f2233f9863e6e7aa"
            ]
        ]
    },
    {
        "id": "e55caf42c0936b6d",
        "type": "firebase.once",
        "z": "3bcad979e3234c31",
        "name": "ƒê·ªçc to√†n b·ªô DB",
        "firebaseconfig": "aee7f3977f504759",
        "childpath": "",
        "repeatifnull": false,
        "eventType": "value",
        "queries": [],
        "x": 630,
        "y": 860,
        "wires": [
            [
                "ded77b69850a81fe"
            ]
        ]
    },
    {
        "id": "510a0e109fb915fc",
        "type": "firebase modify",
        "z": "3bcad979e3234c31",
        "name": "C·∫≠p nh·∫≠t th√¥ng tin ch·ªó tr·ªëng ",
        "firebaseconfig": "aee7f3977f504759",
        "childpath": "",
        "method": "update",
        "value": "msg.payload",
        "priority": "msg.priority",
        "x": 1000,
        "y": 680,
        "wires": [
            [
                "30480459d62a1732"
            ]
        ]
    },
    {
        "id": "7d8b4c92a45976d3",
        "type": "function",
        "z": "3bcad979e3234c31",
        "name": "Th√¥ng b√°o l·ªói/h·∫øt ch·ªó ",
        "func": "if (msg.error_message) {\n     msg.payload = { action: \"deny\", message: msg.error_message, rfid_received: msg.rfid_uid_received, available_spots: msg.spots_to_report_in_response };\n     msg.statusCode = 500; \n} else {\n     // S·ª≠ d·ª•ng th√¥ng b√°o ƒë√£ set trong node tr∆∞·ªõc ƒë√≥ (bf85979b2689e5e8)\n     msg.payload = { action: msg.action_result_final, message: msg.message_final, rfid_received: msg.rfid_uid_received, available_spots: msg.spots_to_report_in_response };\n     msg.statusCode = msg.statusCode_final; \n}\n\n// D·ªçn d·∫πp (gi·ªØ l·∫°i c√°c tr∆∞·ªùng c·∫ßn thi·∫øt cho ph·∫£n h·ªìi)\nconst responsePayload = msg.payload;\nconst statusCode = msg.statusCode;\n\n// X√≥a t·∫•t c·∫£ c√°c tr∆∞·ªùng kh√°c trong msg tr·ª´ _msgid\nfor (const key in msg) {\n    if (key !== '_msgid' && key !== 'payload' && key !== 'statusCode') {\n        delete msg[key];\n    }\n}\n\nmsg.payload = responsePayload; // G√°n l·∫°i payload ph·∫£n h·ªìi\nmsg.statusCode = statusCode; // G√°n l·∫°i statusCode ph·∫£n h·ªìi\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2400,
        "y": 300,
        "wires": [
            [
                "352379eab04bcf58",
                "3b19848949e43781"
            ]
        ]
    },
    {
        "id": "3b19848949e43781",
        "type": "http response",
        "z": "3bcad979e3234c31",
        "name": "ƒê√≥ng c·ªïng",
        "statusCode": "",
        "headers": {},
        "x": 2710,
        "y": 300,
        "wires": []
    },
    {
        "id": "94f36abdded89077",
        "type": "function",
        "z": "3bcad979e3234c31",
        "name": "Th√¥ng b√°o l·ªói/nh·∫ßm th·∫ª",
        "func": "// msg ƒë√£ ƒë∆∞·ª£c chu·∫©n b·ªã v·ªõi th√¥ng tin l·ªói (action_result_final, message_final, status_code_final)\n// trong Function node \"XE RA: T√¨m spot & Chu·∫©n b·ªã c·∫≠p nh·∫≠t\" ·ªü nh√°nh l·ªói.\n\nmsg.payload = {\n    action: msg.action_result_final,\n    message: msg.message_final,\n    rfid_received: msg.rfid_uid_received, // V·∫´n gi·ªØ rfid nh·∫≠n ƒë∆∞·ª£c trong ph·∫£n h·ªìi\n    available_spots: msg.spots_to_report_in_response // B√°o c√°o s·ªë ch·ªó tr·ªëng hi·ªán t·∫°i\n};\nmsg.statusCode = msg.statusCode_final;\n\n// D·ªçn d·∫πp c√°c tr∆∞·ªùng msg kh√¥ng c·∫ßn thi·∫øt cho ph·∫£n h·ªìi\nconst responsePayload = msg.payload;\nconst statusCode = msg.statusCode;\nfor (const key in msg) {\n    if (key !== '_msgid' && key !== 'payload' && key !== 'statusCode') {\n        delete msg[key];\n    }\n}\nmsg.payload = responsePayload;\nmsg.statusCode = statusCode;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1070,
        "y": 920,
        "wires": [
            [
                "501a1aa9724e7fd2",
                "d2e09a231a9fdf9e"
            ]
        ]
    },
    {
        "id": "501a1aa9724e7fd2",
        "type": "http response",
        "z": "3bcad979e3234c31",
        "name": "T·ª´ ch·ªëi m·ªü c·ªïng",
        "statusCode": "",
        "headers": {},
        "x": 1550,
        "y": 920,
        "wires": []
    },
    {
        "id": "e0e91be86a8662f0",
        "type": "debug",
        "z": "3bcad979e3234c31",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 540,
        "y": 60,
        "wires": []
    },
    {
        "id": "34e50b7479ad36ec",
        "type": "debug",
        "z": "3bcad979e3234c31",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1050,
        "y": 60,
        "wires": []
    },
    {
        "id": "0fdd3b76ba0c12bd",
        "type": "debug",
        "z": "3bcad979e3234c31",
        "name": "debug 4",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1570,
        "y": 20,
        "wires": []
    },
    {
        "id": "31ac22796785a1fe",
        "type": "debug",
        "z": "3bcad979e3234c31",
        "name": "debug 5",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1850,
        "y": 360,
        "wires": []
    },
    {
        "id": "20bb7537c93657b3",
        "type": "debug",
        "z": "3bcad979e3234c31",
        "name": "debug 6",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 2630,
        "y": 160,
        "wires": []
    },
    {
        "id": "352379eab04bcf58",
        "type": "debug",
        "z": "3bcad979e3234c31",
        "name": "debug 7",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 2590,
        "y": 360,
        "wires": []
    },
    {
        "id": "df115a108ed489e0",
        "type": "debug",
        "z": "3bcad979e3234c31",
        "name": "debug 11",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 590,
        "y": 700,
        "wires": []
    },
    {
        "id": "01370e80ad490e9b",
        "type": "debug",
        "z": "3bcad979e3234c31",
        "name": "debug 12",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1530,
        "y": 640,
        "wires": []
    },
    {
        "id": "d2e09a231a9fdf9e",
        "type": "debug",
        "z": "3bcad979e3234c31",
        "name": "debug 13",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1330,
        "y": 1000,
        "wires": []
    },
    {
        "id": "9cf35b477c8ca2e7",
        "type": "debug",
        "z": "3bcad979e3234c31",
        "name": "debug 14",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1040,
        "y": 720,
        "wires": []
    },
    {
        "id": "7854a6bbf8335901",
        "type": "debug",
        "z": "3bcad979e3234c31",
        "name": "debug 15",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1040,
        "y": 840,
        "wires": []
    },
    {
        "id": "08591338e8fb8793",
        "type": "debug",
        "z": "3bcad979e3234c31",
        "name": "debug 16",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 230,
        "y": 60,
        "wires": []
    },
    {
        "id": "4f9af2a4c84e8cae",
        "type": "inject",
        "z": "3bcad979e3234c31",
        "name": "",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"rfid_uid\": \"DDEB82C3\"}",
        "payloadType": "str",
        "x": 90,
        "y": 320,
        "wires": [
            [
                "45ed03fceed39806"
            ]
        ]
    },
    {
        "id": "b863f79f19227765",
        "type": "firebase.once",
        "z": "3bcad979e3234c31",
        "name": "ƒê·ªçc ch·ªó tr·ªëng",
        "firebaseconfig": "aee7f3977f504759",
        "childpath": "parking_lots/lot_1",
        "repeatifnull": false,
        "eventType": "value",
        "queries": [],
        "x": 1200,
        "y": 100,
        "wires": [
            [
                "908f454b96d4dd07"
            ]
        ]
    },
    {
        "id": "1716bc4a0c3d0c87",
        "type": "http in",
        "z": "1b48354d57473ee9",
        "name": "",
        "url": "esp8266/ir_update",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 110,
        "y": 160,
        "wires": [
            [
                "c4f87c578acf6e24",
                "044c26cc14933b89"
            ]
        ]
    },
    {
        "id": "c4f87c578acf6e24",
        "type": "json",
        "z": "1b48354d57473ee9",
        "name": "",
        "property": "payload",
        "action": "obj",
        "pretty": false,
        "x": 290,
        "y": 220,
        "wires": [
            [
                "e8e71384a57284f8"
            ]
        ]
    },
    {
        "id": "bd51f1898542eac9",
        "type": "function",
        "z": "1b48354d57473ee9",
        "name": "Ki·ªÉm tra v√† c·∫≠p nh·∫≠t l√™n server",
        "func": "// Payload t·ª´ ESP8266 c·∫£m bi·∫øn IR: { \"slot_id\": \"spot_1\", \"status\": \"occupied\" }\nconst slotId = msg.original_payload.slot_id;\nconst irStatus = msg.original_payload.status;\n\n// msg.payload hi·ªán t·∫°i ch·ª©a to√†n b·ªô d·ªØ li·ªáu c·ªßa parking_lots/lot_1 t·ª´ Firebase\nconst lotData = msg.payload; // D·ªØ li·ªáu hi·ªán t·∫°i c·ªßa lot_1\nconst spots = lotData.spots;\nconst totalSpots = parseInt(lotData.total_spots) || 0;\n\nlet updatePayload = {}; // Payload s·∫Ω ƒë∆∞·ª£c g·ª≠i t·ªõi node firebase modify\nlet currentSpotStatus = spots[slotId] ? spots[slotId].status : \"unknown\";\n\n// 1. Ki·ªÉm tra v√† x√°c th·ª±c d·ªØ li·ªáu ƒë·∫ßu v√†o t·ª´ IR sensor\nif (!slotId || typeof slotId !== 'string' || !irStatus || !['occupied', 'empty'].includes(irStatus)) {\n    node.error(\"IR Sensor: Invalid payload format or value\", msg);\n    msg.payload = { action: 'error_ir', message: 'Y√™u c·∫ßu c·∫≠p nh·∫≠t c·∫£m bi·∫øn kh√¥ng h·ª£p l·ªá: Thi·∫øu ho·∫∑c sai ƒë·ªãnh d·∫°ng slot_id/status' };\n    msg.statusCode = 400;\n    return [null, msg]; // G·ª≠i ƒë·∫øn nh√°nh l·ªói\n}\n\n// 2. X√°c ƒë·ªãnh tr·∫°ng th√°i m·ªõi c·ªßa spot d·ª±a tr√™n IR sensor v√† tr·∫°ng th√°i hi·ªán t·∫°i\nconst targetSpotPath = `parking_lots/lot_1/spots/${slotId}`;\nlet shouldUpdateFirebase = false; // C·ªù ƒë·ªÉ quy·∫øt ƒë·ªãnh c√≥ c·∫ßn g·ª≠i update l√™n Firebase kh√¥ng\n\nif (irStatus === \"occupied\") {\n    if (currentSpotStatus === \"pending_entries\") {\n        // Xe ƒë√£ ·ªü tr·∫°ng th√°i ch·ªù v√†o (pending_entries), nay IR x√°c nh·∫≠n ƒë√£ ƒë·ªó -> chuy·ªÉn sang occupied\n        updatePayload[targetSpotPath + \"/status\"] = \"occupied\";\n        // available_spots kh√¥ng ƒë·ªïi v√¨ ƒë√£ gi·∫£m ·ªü l·ªëi v√†o khi pending_entries\n        // v√† gi·ªù ch·ªâ chuy·ªÉn tr·∫°ng th√°i t·ª´ pending_entries sang occupied.\n        shouldUpdateFirebase = true;\n    } else if (currentSpotStatus === \"empty\") {\n        // IR b√°o occupied nh∆∞ng spot ƒëang empty (xe v√£ng lai tr·ª±c ti·∫øp v√†o ho·∫∑c l·ªói)\n        // T√πy thu·ªôc v√†o logic, c√≥ th·ªÉ chuy·ªÉn sang occupied ho·∫∑c b√°o ƒë·ªông.\n        // ·ªû ƒë√¢y, ta c·∫≠p nh·∫≠t th√†nh occupied.\n        updatePayload[targetSpotPath + \"/status\"] = \"occupied\";\n        // available_spots c·∫ßn gi·∫£m 1 n·∫øu tr·∫°ng th√°i ban ƒë·∫ßu l√† empty\n        // L∆ØU √ù: logic n√†y s·∫Ω kh√¥ng x·∫£y ra n·∫øu xe lu√¥n qua RFID l·ªëi v√†o tr∆∞·ªõc.\n        // N·∫øu mu·ªën x·ª≠ l√Ω tr∆∞·ªùng h·ª£p n√†y, c·∫ßn t√≠nh to√°n available_spots ·ªü ƒë√¢y.\n        // T·∫°m th·ªùi, t√¥i gi·∫£ ƒë·ªãnh m·ªçi xe v√†o ƒë·ªÅu qua RFID ƒë·ªÉ c√≥ pending_entries tr∆∞·ªõc.\n        node.warn(`IR Sensor: Spot ${slotId} was empty but IR reports occupied. Force update to occupied. Available spots will be re-calculated if a new car entered.`);\n        shouldUpdateFirebase = true;\n    } else if (currentSpotStatus === \"occupied\") {\n        // ƒê√£ occupied, kh√¥ng l√†m g√¨ (kh√¥ng c·∫ßn c·∫≠p nh·∫≠t tr·∫°ng th√°i spot)\n        shouldUpdateFirebase = false;\n    } else {\n        // C√°c tr∆∞·ªùng h·ª£p kh√°c (v√≠ d·ª•: reserved nh∆∞ng IR b√°o occupied m√† kh√¥ng qua pending_entries)\n        node.warn(`IR Sensor: Spot ${slotId} is ${currentSpotStatus} but IR reports occupied. Potential issue.`);\n        updatePayload[targetSpotPath + \"/status\"] = \"occupied\";\n        shouldUpdateFirebase = true;\n    }\n} else if (irStatus === \"empty\") {\n    if (currentSpotStatus === \"occupied\" || currentSpotStatus === \"pending_entries\") {\n        // Xe r·ªùi ƒëi: chuy·ªÉn t·ª´ occupied/pending_entries sang empty\n        updatePayload[targetSpotPath + \"/status\"] = \"empty\";\n        // KH√îNG X√ìA RFID TAG V√Ä TIME_IN ·ªû ƒê√ÇY N·ªÆA\n        // updatePayload[targetSpotPath + \"/rfid_tag\"] = null;\n        // updatePayload[targetSpotPath + \"/time_in\"] = null;\n        updatePayload[targetSpotPath + \"/time_out\"] = new Date().toISOString(); // Ghi time_out\n        shouldUpdateFirebase = true;\n\n        // TƒÉng available_spots l√™n 1 khi xe r·ªùi ƒëi\n        const currentAvailableSpots = parseInt(lotData.available_spots) || 0;\n        const newAvailableSpots = Math.min(totalSpots, currentAvailableSpots + 1); // ƒê·∫£m b·∫£o kh√¥ng v∆∞·ª£t qu√° totalSpots\n        updatePayload[`parking_lots/lot_1/available_spots`] = newAvailableSpots;\n\n    } else if (currentSpotStatus === \"empty\") {\n        // ƒê√£ empty, kh√¥ng l√†m g√¨\n        shouldUpdateFirebase = false;\n    } else {\n        // C√°c tr∆∞·ªùng h·ª£p kh√°c (v√≠ d·ª•: reserved nh∆∞ng IR b√°o empty)\n        node.warn(`IR Sensor: Spot ${slotId} is ${currentSpotStatus} but IR reports empty. Force update to empty.`);\n        updatePayload[targetSpotPath + \"/status\"] = \"empty\";\n        // KH√îNG X√ìA RFID TAG V√Ä TIME_IN ·ªû ƒê√ÇY N·ªÆA\n        // updatePayload[targetSpotPath + \"/rfid_tag\"] = null;\n        // updatePayload[targetSpotPath + \"/time_in\"] = null;\n        updatePayload[targetSpotPath + \"/time_out\"] = new Date().toISOString();\n        shouldUpdateFirebase = true;\n\n        // TƒÉng available_spots l√™n 1\n        const currentAvailableSpots = parseInt(lotData.available_spots) || 0;\n        const newAvailableSpots = Math.min(totalSpots, currentAvailableSpots + 1);\n        updatePayload[`parking_lots/lot_1/available_spots`] = newAvailableSpots;\n    }\n}\n\n// 3. G·ª≠i payload c·∫≠p nh·∫≠t t·ªõi Firebase n·∫øu c√≥ thay ƒë·ªïi\nif (shouldUpdateFirebase) {\n    msg.payload = updatePayload;\n    msg.statusCode = 200;\n    msg.action_result_final = \"ir_update_success\";\n    msg.message_final = `Updated spot ${slotId} status to ${irStatus}. Available spots updated.`;\n    return [msg, null]; // G·ª≠i ƒë·∫øn nh√°nh th√†nh c√¥ng\n} else {\n    // Kh√¥ng c√≥ thay ƒë·ªïi tr·∫°ng th√°i n√†o c·∫ßn c·∫≠p nh·∫≠t tr√™n Firebase cho spot n√†y\n    node.warn(`IR Sensor: No actual status change for spot ${slotId}.`);\n    return [null, null]; // D·ª´ng flow n·∫øu kh√¥ng c√≥ g√¨ ƒë·ªÉ c·∫≠p nh·∫≠t\n}",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 180,
        "wires": [
            [
                "8a16763dddccb4a3",
                "8d34b8c41a8e7af5"
            ],
            [
                "01050c9dfd1bfc8a",
                "9facb932f5896959"
            ]
        ]
    },
    {
        "id": "8a16763dddccb4a3",
        "type": "firebase modify",
        "z": "1b48354d57473ee9",
        "name": "C·∫≠p nh·∫≠t tr·∫°ng th√°i spot",
        "firebaseconfig": "aee7f3977f504759",
        "childpath": "",
        "method": "update",
        "value": "msg.payload",
        "priority": "",
        "x": 930,
        "y": 60,
        "wires": [
            [
                "daa0bafd47aa0885"
            ]
        ]
    },
    {
        "id": "daa0bafd47aa0885",
        "type": "http response",
        "z": "1b48354d57473ee9",
        "name": "C·∫≠p nh·∫≠t th√†nh c√¥ng",
        "statusCode": "200",
        "headers": {},
        "x": 1200,
        "y": 60,
        "wires": []
    },
    {
        "id": "01050c9dfd1bfc8a",
        "type": "http response",
        "z": "1b48354d57473ee9",
        "name": "B√°o l·ªói IR Sensor",
        "statusCode": "400",
        "headers": {},
        "x": 1110,
        "y": 240,
        "wires": []
    },
    {
        "id": "044c26cc14933b89",
        "type": "debug",
        "z": "1b48354d57473ee9",
        "name": "debug 8",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 270,
        "y": 100,
        "wires": []
    },
    {
        "id": "8d34b8c41a8e7af5",
        "type": "debug",
        "z": "1b48354d57473ee9",
        "name": "debug 9",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 980,
        "y": 120,
        "wires": []
    },
    {
        "id": "9facb932f5896959",
        "type": "debug",
        "z": "1b48354d57473ee9",
        "name": "debug 10",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1060,
        "y": 320,
        "wires": []
    },
    {
        "id": "e8e71384a57284f8",
        "type": "change",
        "z": "1b48354d57473ee9",
        "name": "L∆∞u original payload",
        "rules": [
            {
                "t": "set",
                "p": "original_payload",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 470,
        "y": 280,
        "wires": [
            [
                "24c20f42a7660a92"
            ]
        ]
    },
    {
        "id": "24c20f42a7660a92",
        "type": "firebase.once",
        "z": "1b48354d57473ee9",
        "name": "ƒê·ªçc d·ªØ li·ªáu b√£i ƒë·ªó",
        "firebaseconfig": "aee7f3977f504759",
        "childpath": "parking_lots/lot_1",
        "repeatifnull": false,
        "eventType": "value",
        "queries": [],
        "x": 490,
        "y": 100,
        "wires": [
            [
                "bd51f1898542eac9"
            ]
        ]
    },
    {
        "id": "e7c2c9d2f21a4f02",
        "type": "inject",
        "z": "1b48354d57473ee9",
        "name": "IR: spot_1 -> occupied (t·ª´ pending_entries)",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"slot_id\":\"spot_2\",\"status\":\"occupied\"}",
        "payloadType": "json",
        "x": 210,
        "y": 360,
        "wires": [
            [
                "c4f87c578acf6e24"
            ]
        ]
    },
    {
        "id": "520f8c3e800d9e11",
        "type": "inject",
        "z": "1b48354d57473ee9",
        "name": "IR: spot_2 -> empty (t·ª´ occupied)",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"slot_id\":\"spot_2\",\"status\":\"empty\"}",
        "payloadType": "json",
        "x": 210,
        "y": 440,
        "wires": [
            [
                "c4f87c578acf6e24"
            ]
        ]
    },
    {
        "id": "8c3b7a5a8f4c9b20",
        "type": "inject",
        "z": "1b48354d57473ee9",
        "name": "IR: spot_3 -> occupied (t·ª´ empty, simulate l·ªói)",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"slot_id\":\"spot_3\",\"status\":\"occupied\"}",
        "payloadType": "json",
        "x": 210,
        "y": 520,
        "wires": [
            [
                "c4f87c578acf6e24"
            ]
        ]
    },
    {
        "id": "58419dfe908211ec",
        "type": "firebase.on",
        "z": "a16b73657f0d2c2a",
        "name": "Realtime Lot 1",
        "firebaseconfig": "aee7f3977f504759",
        "childpath": "parking_lots/lot_1/spots",
        "atStart": true,
        "eventType": "value",
        "queries": [],
        "x": 140,
        "y": 100,
        "wires": [
            [
                "28da355546186fca",
                "f4b0866b3ffe340a"
            ]
        ]
    },
    {
        "id": "28da355546186fca",
        "type": "function",
        "z": "a16b73657f0d2c2a",
        "name": "Chuy·ªÉn danh s√°ch spot",
        "func": "let raw = msg.payload;\nlet result = [];\n\nfor (let spotId in raw) {\n    let s = raw[spotId];\n    result.push({\n        id: spotId,\n        status: s.status || \"empty\",\n        rfid: s.rfid_tag || \"\",\n        time_in: s.time_in || \"\",\n        time_out: s.time_out || \"\",\n        user: s.userID || \"\",\n        booking_ref: s.booking_ref || \"\"\n    });\n}\n\nmsg.payload = result;\n// L∆∞u tr·ªØ danh s√°ch spot ƒë√£ ƒë·ªãnh d·∫°ng v√†o context c·ªßa flow\nflow.set('spotList', result);\n\n// Ki·ªÉm tra n·∫øu msg.selected_spot ch∆∞a ƒë∆∞·ª£c set ho·∫∑c ƒë√£ b·ªã clear\nif (typeof msg.selected_spot === 'undefined' || msg.selected_spot === null) {\n     msg.selected_spot = null; // ƒê·∫£m b·∫£o n√≥ l√† null n·∫øu ch∆∞a c√≥\n}\n\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 100,
        "wires": [
            [
                "32afed69447f2d75",
                "afdfe9179e7aad13"
            ]
        ]
    },
    {
        "id": "32afed69447f2d75",
        "type": "ui_template",
        "z": "a16b73657f0d2c2a",
        "group": "ui_group_lot1",
        "name": "L∆∞·ªõi ch·ªó ƒë·ªó (3x2)",
        "order": 1,
        "width": "12",
        "height": "6",
        "format": "<style>\n  /* ƒê·ªãnh nghƒ©a b·ªë c·ª•c l∆∞·ªõi 2 h√†ng x 3 c·ªôt */\n  .parking-grid {\n    display: grid;\n    grid-template-columns: repeat(3, 1fr);\n    /* 3 c·ªôt c√≥ chi·ªÅu r·ªông b·∫±ng nhau */\n    grid-gap: 15px;\n    /* Kho·∫£ng c√°ch gi·ªØa c√°c √¥ */\n    padding: 10px;\n  }\n\n  /* T√πy ch·ªânh n√∫t b·∫•m */\n  .spot-button {\n    width: 100%;\n    height: 80px;\n    /* Chi·ªÅu cao c·ªë ƒë·ªãnh cho n√∫t */\n    display: flex;\n    /* D√πng flexbox ƒë·ªÉ cƒÉn gi·ªØa n·ªôi dung */\n    flex-direction: column;\n    justify-content: center;\n    align-items: center;\n    text-align: center;\n    font-weight: bold;\n    color: white;\n    /* M√†u ch·ªØ tr·∫Øng */\n    transition: background-color 0.5s ease;\n    /* Hi·ªáu ·ª©ng chuy·ªÉn m√†u n·ªÅn trong 0.5s */\n    border-radius: 5px;\n    /* Bo tr√≤n g√≥c */\n    padding: 5px;\n    box-sizing: border-box;\n    /* T√≠nh padding v√† border v√†o k√≠ch th∆∞·ªõc */\n  }\n\n  /* ƒê·ªãnh nghƒ©a m√†u n·ªÅn cho t·ª´ng tr·∫°ng th√°i */\n  .status-occupied {\n    background-color: #f44336;\n    /* ƒê·ªè */\n  }\n\n  .status-reserved {\n    background-color: #ff9800;\n    /* Cam */\n  }\n\n  .status-empty {\n    background-color: #4caf50;\n    /* Xanh l√° c√¢y */\n  }\n\n  .status-pending-entries {\n    /* TH√äM TR·∫†NG TH√ÅI M·ªöI */\n    background-color: #2196f3;\n    /* Xanh d∆∞∆°ng */\n  }\n\n  .status-unknown {\n    /* Tr∆∞·ªùng h·ª£p tr·∫°ng th√°i kh√¥ng x√°c ƒë·ªãnh */\n    background-color: #9e9e9e;\n    /* X√°m */\n  }\n\n  /* Hi·ªáu ·ª©ng khi hover */\n  .spot-button:hover {\n    opacity: 0.9;\n  }\n</style>\n\n<div ng-if=\"!msg.selected_spot\">\n  <div class=\"parking-grid\">\n    <div ng-repeat=\"spot in msg.payload\">\n      <md-button class=\"md-raised spot-button\" ng-class=\"{\n           'status-occupied': spot.status === 'occupied',\n           'status-reserved': spot.status === 'reserved',\n           'status-empty': spot.status === 'empty',\n           'status-pending-entries': spot.status === 'pending_entries',\n           'status-unknown': !spot.status || (spot.status !== 'occupied' && spot.status !== 'reserved' && spot.status !== 'empty' && spot.status !== 'pending_entries')\n         }\" ng-click=\"send({payload: spot})\">\n        <b>{{spot.id}}</b><br/>{{(spot.status || 'unknown') | uppercase}}\n      </md-button>\n    </div>\n  </div>\n</div>\n\n<script>\n  // H√†m getColor kh√¥ng c√≤n c·∫ßn thi·∫øt v√¨ ch√∫ng ta d√πng ng-class v√† CSS\n  // N·∫øu b·∫°n mu·ªën d√πng l·∫°i getColor cho m·ª•c ƒë√≠ch kh√°c th√¨ gi·ªØ l·∫°i, c√≤n kh√¥ng th√¨ x√≥a ƒëi.\n  // $scope.getColor = function(status) {\n  //  if (status === 'occupied') return '#f44336';\n  //  if (status === 'reserved') return '#ff9800';\n  //  return '#4caf50';\n  // };\n</script>",
        "storeOutMessages": true,
        "fwdInMessages": false,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 790,
        "y": 80,
        "wires": [
            [
                "074be43077c8f699"
            ]
        ]
    },
    {
        "id": "074be43077c8f699",
        "type": "function",
        "z": "a16b73657f0d2c2a",
        "name": "G√°n spot ƒë∆∞·ª£c ch·ªçn",
        "func": "// Node n√†y v·∫´n gi·ªØ nguy√™n nh∆∞ c≈©\nmsg.selected_spot = msg.payload; // msg.payload l√∫c n√†y l√† data c·ªßa spot ƒë∆∞·ª£c click\nmsg.payload = null; // Kh√¥ng c·∫ßn payload ƒë·ªÉ hi·ªÉn th·ªã l∆∞·ªõi n·ªØa\n\n// L·∫•y l·∫°i danh s√°ch spot t·ª´ context flow v√† g√°n v√†o msg.payload\nmsg.payload = flow.get('spotList') || []; // L·∫•y danh s√°ch spot ƒë√£ l∆∞u\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1220,
        "y": 60,
        "wires": [
            [
                "32afed69447f2d75",
                "afdfe9179e7aad13"
            ]
        ]
    },
    {
        "id": "afdfe9179e7aad13",
        "type": "ui_template",
        "z": "a16b73657f0d2c2a",
        "group": "ui_group_lot1",
        "name": "Chi ti·∫øt + Quay l·∫°i",
        "order": 2,
        "width": "12",
        "height": "6",
        "format": "<div ng-if=\"msg.selected_spot\">\n  <div style=\"padding: 15px; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9;\">\n    <h3 style=\"font-size: 1.3em; margin-bottom: 10px; color: #333;\">Chi ti·∫øt ch·ªó ƒë·ªó: {{msg.selected_spot.id}}</h3>\n    <div style=\"font-size: 1em; line-height: 1.6;\">\n      <p style=\"margin-bottom: 5px;\"><b>Tr·∫°ng th√°i:</b> {{msg.selected_spot.status | uppercase}}</p>\n      <p style=\"margin-bottom: 5px;\"><b>RFID:</b> {{msg.selected_spot.rfid || 'N/A'}}</p>\n      <p style=\"margin-bottom: 5px;\"><b>Time In:</b> {{msg.selected_spot.time_in || 'N/A'}}</p>\n      <p style=\"margin-bottom: 5px;\"><b>Time Out:</b> {{msg.selected_spot.time_out || 'N/A'}}</p>\n      <p style=\"margin-bottom: 5px;\"><b>User ID:</b> {{msg.selected_spot.user || 'N/A'}}</p>\n      <p style=\"margin-bottom: 10px;\"><b>Booking Ref:</b> {{msg.selected_spot.booking_ref || 'N/A'}}</p>\n    </div>\n    <md-button class=\"md-raised md-warn\" ng-click=\"send({payload: 'back'})\" style=\"margin-top: 10px;\">‚¨Ö Quay l·∫°i\n    </md-button>\n  </div>\n</div>",
        "storeOutMessages": true,
        "fwdInMessages": false,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 830,
        "y": 260,
        "wires": [
            [
                "05592a4cb2519dd1"
            ]
        ]
    },
    {
        "id": "05592a4cb2519dd1",
        "type": "function",
        "z": "a16b73657f0d2c2a",
        "name": "X·ª≠ l√Ω quay l·∫°i",
        "func": "if (msg.payload === 'back') {\n    msg.selected_spot = null; // ƒê·∫∑t l·∫°i selected_spot v·ªÅ null\n    // L·∫•y l·∫°i danh s√°ch spot t·ª´ context flow v√† g√°n v√†o msg.payload\n    msg.payload = flow.get('spotList') || [];\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1280,
        "y": 260,
        "wires": [
            [
                "32afed69447f2d75",
                "afdfe9179e7aad13"
            ]
        ]
    },
    {
        "id": "f4b0866b3ffe340a",
        "type": "debug",
        "z": "a16b73657f0d2c2a",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 350,
        "y": 300,
        "wires": []
    }
]